---
layout: default
---

<style>
  .frq-wrap { max-width: 980px; margin: 0 auto; padding: 1.25rem; }
  .frq-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,.04); }
  .frq-header { display: flex; flex-wrap: wrap; gap: .75rem; align-items: baseline; justify-content: space-between; margin-bottom: .75rem; }
  .frq-title { font-size: 1.55rem; font-weight: 700; line-height: 1.2; margin: 0; }
  .frq-meta { display: flex; gap: .5rem; flex-wrap: wrap; }
  .chip { font-size: .85rem; padding: .25rem .6rem; border-radius: 999px; background: #f3f4f6; border: 1px solid #e5e7eb; }
  .frq-desc { color: #4b5563; margin: .25rem 0 0; }

  .grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; } }

  .section-title { font-size: 1rem; font-weight: 650; margin: 0 0 .5rem; }
  textarea { width: 100%; min-height: 260px; padding: .75rem; border-radius: 12px; border: 1px solid #e5e7eb; font: inherit; outline: none; background: #fff; }
  textarea:focus { border-color: #93c5fd; box-shadow: 0 0 0 4px rgba(59,130,246,.12); }

  .row { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
  .btn {
    appearance: none; border: 1px solid #e5e7eb; background: #111827; color: #fff;
    padding: .6rem .9rem; border-radius: 12px; font-weight: 650; cursor: pointer;
  }
  .btn.secondary { background: #fff; color: #111827; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }

  .mini { font-size: .9rem; color: #374151; }
  .muted { color: #6b7280; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .panel { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 14px; padding: .85rem; }
  .kv { display: grid; grid-template-columns: 140px 1fr; gap: .4rem .6rem; font-size: .93rem; }
  .kv div:nth-child(odd) { color: #6b7280; }
  .ok { color: #065f46; }
  .warn { color: #92400e; }
  .err { color: #991b1b; }

  .hr { height: 1px; background: #e5e7eb; margin: .85rem 0; }

  details summary { cursor: pointer; font-weight: 650; }
  pre { white-space: pre-wrap; word-break: break-word; background: #0b1020; color: #e5e7eb; padding: .75rem; border-radius: 12px; overflow:auto; }
</style>

<div class="frq-wrap">
  <div class="frq-card">
    <div class="frq-header">
      <div>
        <h1 class="frq-title">
          {{ page.title | default: "FRQ" }}
        </h1>
        <p class="frq-desc">
          {{ page.description | default: "" }}
        </p>
      </div>
      <div class="frq-meta">
        <span class="chip">Year: <strong>{{ page.year }}</strong></span>
        <span class="chip">FRQ: <strong>{{ page.frq_number }}</strong></span>
        {% if page.unit %}<span class="chip">Unit: <strong>{{ page.unit }}</strong></span>{% endif %}
        {% if page.category %}<span class="chip">Category: <strong>{{ page.category }}</strong></span>{% endif %}
      </div>
    </div>

    <div class="grid">
      <!-- Left: Prompt + Response -->
      <div>
        <h2 class="section-title">FRQ Prompt</h2>
        <div class="panel">
          {{ content }}
        </div>

        <div class="hr"></div>

        <h2 class="section-title">Your Response</h2>
        <textarea id="responseBox" placeholder="Write your FRQ response here..."></textarea>

        <div class="row" style="margin-top:.75rem;">
          <button id="saveBtn" class="btn secondary" type="button">Save Draft</button>
          <button id="submitBtn" class="btn" type="button">Submit + Get Feedback</button>
          <span id="status" class="mini muted"></span>
        </div>

        <div class="row" style="margin-top:.5rem;">
          <span class="mini muted">Draft autosaves locally. Backend submission happens when you click “Submit + Get Feedback”.</span>
        </div>
      </div>

      <!-- Right: Config + Results -->
      <div>
        <h2 class="section-title">Settings</h2>
        <div class="panel">
          <div class="kv">
            <div>assignmentId</div><div class="mono" id="assignmentIdView">—</div>
            <div>submitterId</div><div class="mono" id="submitterIdView">—</div>
            <div>isGroup</div><div class="mono" id="isGroupView">false</div>
          </div>

          <div class="row" style="margin-top:.75rem;">
            <button id="configBtn" class="btn secondary" type="button">Set / Change IDs</button>
            <button id="clearBtn" class="btn secondary" type="button">Clear Draft</button>
          </div>

          <p class="mini muted" style="margin:.6rem 0 0;">
            You only have to set these once per FRQ page. They’re stored in <span class="mono">localStorage</span>.
          </p>
        </div>

        <div class="hr"></div>

        <h2 class="section-title">Latest Result</h2>
        <div class="panel">
          <div class="kv">
            <div>submissionId</div><div class="mono" id="submissionIdView">—</div>
            <div>grade</div><div class="mono" id="gradeView">—</div>
            <div>feedback</div><div id="feedbackView">—</div>
          </div>

          <div class="row" style="margin-top:.75rem;">
            <button id="refreshBtn" class="btn secondary" type="button">Refresh Result</button>
          </div>

          <details style="margin-top:.75rem;">
            <summary>Debug</summary>
            <pre id="debugBox">No debug yet.</pre>
          </details>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // ---------- Helpers ----------
  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setStatus(msg, cls) {
    const el = document.getElementById("status");
    el.className = "mini " + (cls || "muted");
    el.textContent = msg || "";
  }

  function setDebug(obj) {
    const el = document.getElementById("debugBox");
    try {
      el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    } catch {
      el.textContent = String(obj);
    }
  }

  async function apiFetch(url, options) {
    const res = await fetch(url, {
      credentials: "include", // IMPORTANT for Spring Security cookie/session
      headers: { "Content-Type": "application/json", ...(options?.headers || {}) },
      ...options
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }

    if (!res.ok) {
      const err = new Error("HTTP " + res.status + " for " + url);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function storageKeyBase() {
    // unique per FRQ page
    const year = "{{ page.year }}";
    const n = "{{ page.frq_number }}";
    return `frq:${year}:${n}`;
  }

  function getLocalConfig() {
    const base = storageKeyBase();
    const assignmentId = localStorage.getItem(base + ":assignmentId");
    const submitterId = localStorage.getItem(base + ":submitterId");
    const isGroup = localStorage.getItem(base + ":isGroup") === "true";
    const lastSubmissionId = localStorage.getItem(base + ":lastSubmissionId");
    return { assignmentId, submitterId, isGroup, lastSubmissionId };
  }

  function setLocalConfig({ assignmentId, submitterId, isGroup, lastSubmissionId }) {
    const base = storageKeyBase();
    if (assignmentId != null) localStorage.setItem(base + ":assignmentId", String(assignmentId));
    if (submitterId != null) localStorage.setItem(base + ":submitterId", String(submitterId));
    if (isGroup != null) localStorage.setItem(base + ":isGroup", String(!!isGroup));
    if (lastSubmissionId != null) localStorage.setItem(base + ":lastSubmissionId", String(lastSubmissionId));
  }

  function getDraft() {
    const base = storageKeyBase();
    return localStorage.getItem(base + ":draft") || "";
  }

  function setDraft(text) {
    const base = storageKeyBase();
    localStorage.setItem(base + ":draft", text ?? "");
  }

  function renderConfig() {
    const cfg = getLocalConfig();
    document.getElementById("assignmentIdView").textContent = cfg.assignmentId || "—";
    document.getElementById("submitterIdView").textContent = cfg.submitterId || "—";
    document.getElementById("isGroupView").textContent = String(!!cfg.isGroup);
    document.getElementById("submissionIdView").textContent = cfg.lastSubmissionId || "—";
  }

  function renderResult({ submissionId, grade, feedback }) {
    document.getElementById("submissionIdView").textContent = submissionId ?? "—";
    document.getElementById("gradeView").textContent = (grade == null ? "—" : String(grade));
    document.getElementById("feedbackView").textContent = feedback ?? "—";
  }

  // Try to find grade/feedback keys even if DTO differs
  function extractGradeAndFeedback(submissionObj) {
    // common candidates
    const grade =
      submissionObj?.grade ??
      submissionObj?.normalizedGrade ??
      submissionObj?.score ??
      submissionObj?.pointsEarned ??
      null;

    const feedback =
      submissionObj?.feedback ??
      submissionObj?.commentary ??
      submissionObj?.teacherComments ??
      submissionObj?.aiFeedback ??
      null;

    return { grade, feedback };
  }

  // ---------- Core actions ----------
  async function submitAndGrade() {
    const cfg = getLocalConfig();
    const assignmentId = cfg.assignmentId;
    const submitterId = cfg.submitterId;

    if (!assignmentId || !submitterId) {
      setStatus("Set assignmentId + submitterId first.", "warn");
      return;
    }

    const responseText = document.getElementById("responseBox").value.trim();
    if (!responseText) {
      setStatus("Write a response first.", "warn");
      return;
    }

    setStatus("Submitting…", "muted");

    // 1) Submit
    const submitUrl = `/api/submissions/submit/${encodeURIComponent(assignmentId)}`;
    const body = {
      submitterId: Number(submitterId),
      isGroup: !!cfg.isGroup,
      content: responseText,
      comment: "",
      isLate: false
    };

    let submitResp;
    try {
      submitResp = await apiFetch(submitUrl, { method: "POST", body: JSON.stringify(body) });
    } catch (e) {
      setStatus("Submit failed. Check Debug.", "err");
      setDebug({ step: "submit", url: submitUrl, body, error: { status: e.status, data: e.data, message: e.message } });
      return;
    }

    // submission id might be: id OR submissionId
    const submissionId = submitResp?.id ?? submitResp?.submissionId ?? submitResp?.submission?.id ?? null;
    if (!submissionId) {
      setStatus("Submitted, but couldn’t find submissionId in response.", "warn");
      setDebug({ step: "submit", submitResp });
      return;
    }

    setLocalConfig({ lastSubmissionId: submissionId });
    renderConfig();
    renderResult({ submissionId, grade: null, feedback: null });

    // 2) Trigger Gemini grading
    setStatus("Generating feedback (Gemini)…", "muted");
    const gradeUrl = `/api/frq-feedback/submission/${encodeURIComponent(submissionId)}`;

    let gradeResp;
    try {
      gradeResp = await apiFetch(gradeUrl, { method: "POST" });
    } catch (e) {
      setStatus("Feedback generation failed. Check Debug.", "err");
      setDebug({ step: "gemini", url: gradeUrl, error: { status: e.status, data: e.data, message: e.message } });
      return;
    }

    // 3) Refresh result from submissions list (because Gemini service updates submission.grade & submission.feedback)
    setStatus("Fetching updated grade…", "muted");
    await refreshResult(true);

    setDebug({ submitResp, gradeResp });
    setStatus("Done ✅", "ok");
  }

  async function refreshResult(silent) {
    const cfg = getLocalConfig();
    const submitterId = cfg.submitterId;
    const submissionId = cfg.lastSubmissionId;

    if (!submitterId) {
      if (!silent) setStatus("Set submitterId first.", "warn");
      return;
    }
    if (!submissionId) {
      if (!silent) setStatus("No submissionId yet. Submit first.", "warn");
      return;
    }

    const url = `/api/submissions/getSubmissions/${encodeURIComponent(submitterId)}`;

    let list;
    try {
      list = await apiFetch(url, { method: "GET" });
    } catch (e) {
      if (!silent) setStatus("Refresh failed. Check Debug.", "err");
      setDebug({ step: "refresh", url, error: { status: e.status, data: e.data, message: e.message } });
      return;
    }

    // list is an array of submission DTOs
    const match = Array.isArray(list)
      ? list.find(x => String(x?.id ?? x?.submissionId ?? "") === String(submissionId))
      : null;

    if (!match) {
      if (!silent) setStatus("Couldn’t find that submission in the list yet (try again).", "warn");
      setDebug({ step: "refresh", submissionId, returnedCount: Array.isArray(list) ? list.length : null, sample: Array.isArray(list) ? list.slice(0, 2) : list });
      return;
    }

    const { grade, feedback } = extractGradeAndFeedback(match);

    renderResult({
      submissionId,
      grade,
      feedback
    });

    if (!silent) setStatus("Result refreshed ✅", "ok");
  }

  function promptForConfig() {
    const cfg = getLocalConfig();

    const assignmentId = prompt("Enter assignmentId (the Assignment DB id for this FRQ):", cfg.assignmentId || "");
    if (assignmentId == null) return;

    const submitterId = prompt("Enter your submitterId (your Person.id; NOT uid/email):", cfg.submitterId || "");
    if (submitterId == null) return;

    const isGroup = confirm("Is this a group submission? (OK = group, Cancel = individual)");
    setLocalConfig({ assignmentId: assignmentId.trim(), submitterId: submitterId.trim(), isGroup });
    renderConfig();
    setStatus("Saved IDs ✅", "ok");
  }

  // ---------- Init ----------
  const box = document.getElementById("responseBox");
  box.value = getDraft();
  renderConfig();

  box.addEventListener("input", () => {
    setDraft(box.value);
    // soft status (don’t spam)
    setStatus("Draft saved locally.", "muted");
  });

  document.getElementById("saveBtn").addEventListener("click", () => {
    setDraft(box.value);
    setStatus("Draft saved ✅", "ok");
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear this FRQ draft?")) return;
    box.value = "";
    setDraft("");
    setStatus("Draft cleared.", "ok");
  });

  document.getElementById("configBtn").addEventListener("click", promptForConfig);

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;
    try { await submitAndGrade(); }
    finally { btn.disabled = false; }
  });

  document.getElementById("refreshBtn").addEventListener("click", () => refreshResult(false));

  // If config missing, prompt once (nice UX)
  const cfg = getLocalConfig();
  if (!cfg.assignmentId || !cfg.submitterId) {
    setStatus("Click “Set / Change IDs” to enter assignmentId + submitterId.", "warn");
  } else {
    setStatus("Ready.", "muted");
  }
})();
</script>
