---
layout: post
---

{% assign shared = site.data.cs %}
{% assign course = site.data[page.course] %}
{% assign units = page.units | split: ',' %}
{% assign posts = null | compact %}
{% assign posts = posts | concat: site.posts | concat: site.pages %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="{{ '/assets/css/timeline.scss' | relative_url }}">
<script src="{{ '/assets/js/help-video.js' | relative_url }}"></script>

<div class="timeline-page"> 
<div class="timeline-header">
  <h1>Course Timeline</h1>  
</div>

<div class="timeline-container">
  {% for unit in units %}
    {% assign unitKey = "Sprint" | append: unit %}
    {% assign unitData = course[unitKey] %}
    {% assign courseUnit = course[unitKey] %}
    {% assign start = unitData.start %}
    {% assign end = unitData.end %}
    {% assign helpUrl = unitData.help %}

    {% if courseUnit.shared %}
      {% assign unitData = shared[courseUnit.shared] %}
    {% endif %}

    <div class="sprint-card collapsed" data-sprint="{{ unitKey }}" data-course="{{ page.course }}">
      <div class="sprint-header">
        <div>
          <p class="sprint-meta">{{ unitKey }}</p>
          <h2 class="sprint-title">{{ unitData.title }}</h2>
          {% if unitData.description %}
            <p class="sprint-meta">{{ unitData.description }}</p>
          {% endif %}
        </div>
        <div class="sprint-controls">
          <!-- Sprint Date Assignment -->
          <div class="sprint-date-control">
            <button class="sprint-btn date-toggle" type="button" data-sprint="{{ unitKey }}" title="Set Sprint Dates">
              <i class="fas fa-calendar-alt"></i>
            </button>
            <div class="sprint-date-dropdown hidden" data-sprint="{{ unitKey }}">
              <div class="date-dropdown-header">
                <span>Sprint Dates</span>
                <button class="date-dropdown-close" type="button">&times;</button>
              </div>
              <div class="date-input-group">
                <label>Start Date:</label>
                <input type="date" class="sprint-start-date" data-sprint="{{ unitKey }}" data-course="{{ page.course }}">
              </div>
              <div class="date-input-group">
                <label>End Date:</label>
                <input type="date" class="sprint-end-date" data-sprint="{{ unitKey }}" data-course="{{ page.course }}">
              </div>
              <div class="date-actions">
                <button class="save-sprint-dates-btn" data-sprint="{{ unitKey }}" data-course="{{ page.course }}" data-start-week="{{ start }}" data-end-week="{{ end }}">
                  <i class="fas fa-save"></i> Save & Add to Calendar
                </button>
              </div>
              <p class="sprint-date-status" data-sprint="{{ unitKey }}"></p>
            </div>
          </div>
          <button class="sprint-toggle-btn" type="button" aria-expanded="false">
            <span class="sprint-toggle-icon">▾</span> {{ start }} - {{ end }} Weeks
          </button>
          {% if helpUrl %}
          <button class="sprint-btn help" type="button" data-sprint="{{ unitKey }}" data-help-url="{{ helpUrl }}" onclick="openHelpModal('{{ unitKey }}', '{{ helpUrl }}')" title="Help & Navigation Guide">
              <i class="fas fa-question"></i>
          </button>
          {% endif %}
          <button class="sprint-btn certificate" type="button" data-sprint="{{ unitKey }}" data-start="{{ start }}" data-end="{{ end }}" onclick="openProgressionModal('{{ unitKey }}', {{ start }}, {{ end }})" title="Progress & Certificates">
              <i class="fas fa-certificate"></i>
          </button>
        </div>
      </div>

      <div class="sprint-weeks">
        <div class="sprint-body">

          {% for index in (start..end) %}
            {% assign entries = null | compact %}
            {% assign totalItems = 0 %}

            {% for post in posts %}
              {% if post.courses[page.course] %}
                {% comment %}Include all files with courses frontmatter (including converted notebook markdown files){% endcomment %}
                {% comment %}Skip files with multiple courses - they should use course-specific versions{% endcomment %}
                {% assign course_count = 0 %}
                {% for course in post.courses %}
                  {% assign course_count = course_count | plus: 1 %}
                {% endfor %}
                {% if course_count == 1 %}
                {% assign week = post.courses[page.course].week | plus: 0 %}
                {% if week == index %}
                  {% if post.assignment == true %}
                    {% assign itemType = "assignment" %}
                  {% else %}
                    {% assign itemType = "lesson" %}
                  {% endif %}
                  {% assign entry = post.title | append: "||" | append: post.url | append: "||" | append: itemType %}
                  {% assign entries = entries | push: entry %}
                  {% assign totalItems = totalItems | plus: 1 %}
                {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

          {% if entries.size > 0 %}
            {% assign assignmentTitles = "" %}
            {% for entry in entries %}
              {% assign parts = entry | split: "||" %}
              {% if parts[2] == "assignment" %}
                {% if assignmentTitles != "" %}
                  {% assign assignmentTitles = assignmentTitles | append: ";;;" %}
                {% endif %}
                {% assign assignmentTitles = assignmentTitles | append: parts[0] %}
              {% endif %}
            {% endfor %}
            <div class="week-card clickable" data-week="{{ index }}" data-sprint="{{ unitKey }}" data-assignments="{{ assignmentTitles | escape }}">
              <div class="week-content-wrapper">
                <div class="week-indicator">
                  <div class="week-circle">W{{ index }}</div>
                  <div class="week-connector"></div>
                </div>

                <div class="week-main-content">
                  <div class="week-header">
                    <div class="week-title-group">
                      <h3 data-week-title>Week {{ index }}</h3>
                    </div>
                    <div class="week-actions">
                      <div class="completion-badge">
                        {{ completedItems }}/{{ totalItems }} Complete
                      </div>
                    </div>
                  </div>
                  <div class="progress-bar-container">
                    {% if totalItems > 0 %}
                      {% assign progress = completedItems | times: 100 | divided_by: totalItems %}
                    {% else %}
                      {% assign progress = 0 %}
                    {% endif %}
                    <div class="progress-bar-fill" data-progress="{{ progress }}"></div>
                  </div>

                  <!-- MOVED: Learning Goals now appear BEFORE items -->
                  <div class="week-skills-row" data-week-skills></div>

                  <div class="items-grid">
                    {% for entry in entries %}
                      {% assign parts = entry | split: "||" %}
                      {% if parts[2] == "assignment" %}
                        {% assign isAssignment = true %}
                        {% assign itemType = "assignment" %}
                      {% else %}
                        {% assign isAssignment = false %}
                        {% assign itemType = "lesson" %}
                      {% endif %}

                      <div class="item-card" data-type="{{ itemType }}" data-item-id="{{ parts[1] }}">
                        <div class="item-content">
                          <button class="completion-toggle">
                            <i class="fas fa-circle status-icon incomplete"></i>
                          </button>
                          <a href="{{ site.baseurl }}{{ parts[1] }}" class="item-link">
                            {% if isAssignment %}
                              <i class="fas fa-file-alt type-icon assignment"></i>
                            {% else %}
                              <i class="fas fa-code type-icon lesson"></i>
                            {% endif %}
                            <span class="item-title">{{ parts[0] }}</span>
                          </a>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  {% assign assignmentCount = 0 %}
                  {% for entry in entries %}
                    {% assign parts = entry | split: "||" %}
                    {% if parts[2] == "assignment" %}
                      {% assign assignmentCount = assignmentCount | plus: 1 %}
                    {% endif %}
                  {% endfor %}

                  {% if assignmentCount > 0 %}
                    <div class="assignment-due">
                      <i class="fas fa-calendar"></i>
                      <span>{{ assignmentCount }} assignment{% if assignmentCount > 1 %}s{% endif %} due</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- ============================= -->
<!--   PROGRESSION MODAL (DARK)   -->
<!-- ============================= -->
<div id="progression-modal">
  <div>
    <button id="close-progression-modal" class="close-btn">&times;</button>
    
    <h2><span id="modal-sprint-title"></span> Progress</h2>
    <p class="week-theme" id="modal-sprint-subtitle"></p>

    <div class="progress-bar-container" style="margin-bottom: 16px;">
      <div id="modal-progress-fill" style="height: 8px; background: #60a5fa; width: 0%; transition: width 0.3s;"></div>
    </div>

    <div id="task-list"></div>

    <div id="certificate-status" style="margin-top: 24px;"></div>
  </div>
</div>

<!-- ============================= -->
<!--   CERTIFICATE LIST MODAL      -->
<!-- ============================= -->
<div id="certificate-list-modal">
  <button id="close-certificate-list-modal" class="close-btn">&times;</button>

  <div>
    <h2><span id="list-modal-sprint-title"></span> Certificates</h2>
    <div id="certificate-list"></div>
  </div>
</div>

<!-- ============================= -->
<!--     CERTIFICATE MODAL         -->
<!-- ============================= -->
<div id="certificate-modal">
  <div class="action-bar">
    <button id="download-certificate-btn" class="action-btn">Download PNG</button>
    <button id="print-certificate-btn" class="action-btn secondary-btn">Print</button>
    <button id="linkedin-share-btn" class="action-btn">Add to LinkedIn</button>
    <button id="close-certificate-modal" class="action-btn secondary-btn">Close</button>
  </div>

  <div id="certificate-content">
    <div>
      <div class="certificate-heading">
        <div class="certificate-emblem">
          <img id="certificate-logo" src="{{ '/assets/images/ocs-logo.png' | relative_url }}" alt="Open Coding Society Logo">
        </div>
        <div class="header-text">Open Coding Society</div>
        <div class="certify-text">Certificate of Completion</div>
        <div class="certificate-subtitle">Presented to</div>
      </div>

      <div
        contenteditable="true"
        id="certificate-student-name"
      ></div>

      <div class="achievement-text">
        Has successfully completed the module:
        <br><strong id="certificate-week-theme"></strong><br>
        as part of the course<br>
        <strong id="certificate-course-name"></strong>.
      </div>

      <div class="skill-focus-pill">
        <span id="certificate-skill-focus">Skill Focus</span>
      </div>

      <div id="certificate-date"></div>

      <div class="certificate-divider"></div>

      <!-- Skills -->
      <div id="certificate-skills">
        <h3 class="skills-heading">Skills Demonstrated</h3>
        <div id="skills-container"></div>
      </div>

      <!-- Signature -->
      <div class="signature-section">
        <div class="signature">
          <div class="signature-line"></div>
          <div class="signature-name">John Mortensen</div>
          <div class="signature-title">Course Instructor</div>
          <div class="signature-subtitle">Open Coding Society</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ============================= -->
<!--       HELP MODAL              -->
<!-- ============================= -->
<div id="help-modal">
  <div>
    <button id="close-help-modal" class="close-btn">&times;</button>
    
    <div id="help-content" >
      <!-- Markdown content will be loaded here -->
    </div>
  </div>
</div>
<!-- Embed course skill library as application/json (avoid problematic Liquid default with {} ) -->
<script id="course-skill-lib-json" type="application/json">
  {{ course | jsonify }}
</script>

<script>
  // Completion tracking (course-specific)
  const CURRENT_COURSE = '{{ page.course }}';
  const STORAGE_KEY = `${CURRENT_COURSE}-lesson-completion`;

  // Load the skill library from the JSON script tag so the JS file itself contains no raw Liquid tokens
  let COURSE_SKILL_LIBRARY = {};
  try {
    const el = document.getElementById('course-skill-lib-json');
    if (el && el.textContent) {
      COURSE_SKILL_LIBRARY = JSON.parse(el.textContent);
    }
  } catch (e) {
    console.warn('Unable to parse COURSE_SKILL_LIBRARY, falling back to empty object', e);
    COURSE_SKILL_LIBRARY = {};
  }

  // Load completion data from localStorage
  function loadCompletionData() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.error('Error loading completion data:', e);
      return {};
    }
  }
  
  // Save completion data to localStorage
  function saveCompletionData(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error('Error saving completion data:', e);
    }
  }
  
  // Toggle completion status
  function toggleCompletion(button) {
    try {
      const itemCard = button.closest('.item-card');
      if (!itemCard) {
        console.error('Could not find item card');
        return;
      }
      
      const itemId = itemCard.dataset.itemId;
      const completionData = loadCompletionData();
      const isCompleted = completionData[itemId] || false;
      
      // Toggle status
      completionData[itemId] = !isCompleted;
      saveCompletionData(completionData);
      
      // Update UI
      updateItemUI(itemCard, !isCompleted);
      updateProgressBars();
      
      // Trigger cross-view sync by dispatching a custom event
      window.dispatchEvent(new CustomEvent('completionChanged', { 
        detail: { itemId, completed: !isCompleted }
      }));
    } catch (error) {
      console.error('Error in toggleCompletion:', error);
    }
  }
  
  // Update item UI based on completion status
  function updateItemUI(itemCard, isCompleted) {
    const statusIcon = itemCard.querySelector('.status-icon');
    
    if (isCompleted) {
      statusIcon.classList.remove('fa-circle', 'incomplete');
      statusIcon.classList.add('fa-circle-check', 'completed');
      itemCard.classList.add('completed');
    } else {
      statusIcon.classList.remove('fa-circle-check', 'completed');
      statusIcon.classList.add('fa-circle', 'incomplete');
      itemCard.classList.remove('completed');
    }
  }
  
  // Update progress bars for all weeks
  function updateProgressBars() {
    const weekCards = document.querySelectorAll('.week-card');
    
    weekCards.forEach(weekCard => {
      const itemCards = weekCard.querySelectorAll('.item-card');
      const completionBadge = weekCard.querySelector('.completion-badge');
      const progressFill = weekCard.querySelector('.progress-bar-fill');
      
      let totalItems = itemCards.length;
      let completedItems = 0;
      
      itemCards.forEach(card => {
        if (card.classList.contains('completed')) {
          completedItems++;
        }
      });
      
      const progress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
      
      // Update badge
      if (completionBadge) {
        completionBadge.textContent = `${completedItems}/${totalItems} Complete`;
      }
      
      // Update progress bar
      if (progressFill) {
        progressFill.style.width = `${progress}%`;
      }
    });
  }
  
  // Initialize completion states on page load
  function initializeCompletion() {
    const completionData = loadCompletionData();
    const itemCards = document.querySelectorAll('.item-card');
    
    itemCards.forEach(card => {
      const itemId = card.dataset.itemId;
      const isCompleted = completionData[itemId] || false;
      updateItemUI(card, isCompleted);
      
      // Add click event listener to the completion toggle button
      const toggleButton = card.querySelector('.completion-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleCompletion(this);
        });
      }
    });
    
    updateProgressBars();
  }
  
  // Filter functionality - per sprint
  function applySprintFilters(sprintKey, filterType) {
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    if (!sprintCard) return;
    
    const itemCards = sprintCard.querySelectorAll('.item-card');
    
    itemCards.forEach(card => {
      const type = card.dataset.type;
      const isCompleted = card.classList.contains('completed');
      
      if (filterType === 'all') {
        card.style.display = 'block';
      } else if (filterType === 'lessons' && type === 'lesson') {
        card.style.display = 'block';
      } else if (filterType === 'assignments' && type === 'assignment') {
        card.style.display = 'block';
      } else if (filterType === 'incomplete' && !isCompleted) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // Initialize sprint filters
  function initializeSprintFilters() {
    document.querySelectorAll('.sprint-filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent sprint toggle
        
        const sprintKey = btn.dataset.sprint;
        const filterType = btn.dataset.filter;
        
        // Update active state for this sprint's filters only
        const sprintCard = btn.closest('.sprint-card');
        sprintCard.querySelectorAll('.sprint-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Apply filter
        applySprintFilters(sprintKey, filterType);
      });
    });
  }
  
  // Initialize progress bars from data attributes
  function initializeProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar-fill');
    progressBars.forEach(bar => {
      const progress = bar.dataset.progress || 0;
      bar.style.width = `${progress}%`;
    });
  }
  
  let currentModalWeekNumber = null;
  let activeCertificateProfile = null;

  const COURSE_LABELS = {
    csp: 'Computer Science Principles',
    csa: 'Computer Science A',
    csse: 'Computer Science and Software Engineering'
  };

  // Extract week number from week card
  function extractWeekNumber(weekCard) {
    const weekCircle = weekCard.querySelector('.week-circle');
    if (weekCircle) {
      const text = weekCircle.textContent.trim();
      const match = text.match(/W(\d+)/);
      return match ? parseInt(match[1]) : null;
    }
    return null;
  }

  function getWeekCardElement(weekNumber) {
    return Array.from(document.querySelectorAll('.week-card')).find(card => extractWeekNumber(card) === weekNumber);
  }

  function collectGoalsFromWeekCard(weekCard) {
    const titles = Array.from(weekCard.querySelectorAll('.item-title')).map(el => el.textContent.trim()).filter(Boolean);
    const uniqueTitles = [...new Set(titles)];
    if (uniqueTitles.length > 0) {
      return uniqueTitles;
    }
    const header = weekCard.querySelector('.week-title-group h3')?.textContent.trim();
    return header ? [header] : [];
  }

  function buildCertificateProfile(weekCard, weekNumber) {
    // Get sprint key from week card to access the correct sprint's week data
    const sprintKey = weekCard.dataset.sprint;
    const overrides = COURSE_SKILL_LIBRARY?.[sprintKey]?.[weekNumber] || null;
    let theme = overrides?.theme || overrides?.title || overrides?.certificate || '';
    const weekHeader = weekCard.querySelector('.week-title-group h3')?.textContent.trim() || `Week ${weekNumber}`;
    if (!theme) {
      const headerParts = weekHeader.split(':');
      theme = headerParts.length > 1 ? headerParts[1].trim() : weekHeader;
    }
    const goals = (overrides?.goals && overrides.goals.length > 0) ? overrides.goals : collectGoalsFromWeekCard(weekCard);
    if (goals.length === 0) {
      goals.push(theme);
    }
    return {
      weekNumber,
      theme,
      displayName: overrides?.certificate || `Week ${weekNumber}: ${theme}`,
      courseName: COURSE_LABELS[CURRENT_COURSE] || CURRENT_COURSE,
      goals
    };
  }

  function renderWeekGoalPreviews() {
    document.querySelectorAll('.week-card').forEach(card => {
      const preview = card.querySelector('[data-week-skills]');
      if (!preview) return;
      const weekNumber = extractWeekNumber(card);
      const profile = buildCertificateProfile(card, weekNumber);
      if (!profile) return;
      preview.innerHTML = '';
      preview.className = 'week-goals-container';
      
      // Add label
      const label = document.createElement('span');
      label.className = 'goals-label';
      label.textContent = 'Learning Goals';
      preview.appendChild(label);
      
      // Add goals list
      const goalsList = document.createElement('div');
      goalsList.className = 'goals-list';
      
      profile.goals.slice(0, 4).forEach(goal => {
        const item = document.createElement('span');
        item.className = 'goal-item';
        item.textContent = goal;
        goalsList.appendChild(item);
      });
      
      preview.appendChild(goalsList);
      
      const weekTitle = card.querySelector('[data-week-title]');
      if (weekTitle) {
        weekTitle.textContent = `Week ${weekNumber}: ${profile.theme}`;
      }
    });
  }

  // Get available certificates for a week
  function getAvailableCertificates(weekNumber) {
    console.log('Getting certificates for week:', weekNumber);
    const weekCard = getWeekCardElement(weekNumber);

    if (!weekCard) {
      console.log('Week card not found for week:', weekNumber);
      return [];
    }

    const itemCards = weekCard.querySelectorAll('.item-card');
    console.log('Found', itemCards.length, 'item cards');
    if (itemCards.length === 0) {
      return [];
    }

    const allCompleted = Array.from(itemCards).every(card => card.classList.contains('completed'));
    if (!allCompleted) {
      console.log('Week not fully completed, certificates locked.');
      return [];
    }

    const profile = buildCertificateProfile(weekCard, weekNumber);
    if (!profile) {
      return [];
    }

    const certificates = (profile.goals || []).map(goalName => {
      return {
        weekNumber: profile.weekNumber,
        theme: profile.theme,
        courseName: profile.courseName,
        goal: goalName,
        displayName: `${profile.theme} – ${goalName}`,
        slug: `${CURRENT_COURSE}-${profile.weekNumber}-${goalName}`.toLowerCase().replace(/[^a-z0-9]+/g, '-')
      };
    });

    return certificates;
  }

  // Open progression modal for entire sprint
  function openProgressionModal(sprintKey, startWeek, endWeek) {
    console.log('Opening progression modal for sprint:', sprintKey, 'weeks', startWeek, '-', endWeek);
    
    currentModalWeekNumber = null; // Not using this for sprint-level
    
    // Get sprint card and title
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    if (!sprintCard) {
      console.log('Sprint card not found');
      return;
    }
    
    const sprintTitle = sprintCard.querySelector('.sprint-title')?.textContent || sprintKey;
    const sprintDescription = sprintCard.querySelector('.sprint-meta:last-of-type')?.textContent || '';
    
    // Set sprint title and subtitle
    document.getElementById('modal-sprint-title').textContent = sprintTitle;
    document.getElementById('modal-sprint-subtitle').textContent = `${sprintKey} (Weeks ${startWeek}-${endWeek})`;

    // Populate task list with all weeks in sprint
    const taskList = document.getElementById('task-list');
    taskList.innerHTML = '';
    
    let globalTaskIndex = 0;
    
    // Iterate through all weeks in the sprint
    for (let weekNum = startWeek; weekNum <= endWeek; weekNum++) {
      const weekCard = Array.from(sprintCard.querySelectorAll('.week-card')).find(card => 
        extractWeekNumber(card) === weekNum
      );
      
      if (!weekCard) continue;
      
      // Add week header in task list
      const weekHeader = document.createElement('div');
      weekHeader.className = 'progression-week-header';
      const weekTitle = weekCard.querySelector('[data-week-title]')?.textContent || `Week ${weekNum}`;
      weekHeader.textContent = weekTitle;
      taskList.appendChild(weekHeader);
      
      // Add tasks for this week
      const itemCards = weekCard.querySelectorAll('.item-card');
      itemCards.forEach((card) => {
        const title = card.querySelector('.item-title').textContent;
        const isCompleted = card.classList.contains('completed');
        const taskDiv = document.createElement('div');
        taskDiv.className = 'progression-task';
        taskDiv.innerHTML = `
          <input type="checkbox" id="task-${globalTaskIndex}" ${isCompleted ? 'checked' : ''}>
          <label for="task-${globalTaskIndex}">${title}</label>
          <span class="task-number">#${globalTaskIndex + 1}</span>
        `;

        // Add change listener
        const checkbox = taskDiv.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
          const toggleBtn = card.querySelector('.completion-toggle');
          if (toggleBtn) {
            toggleCompletion(toggleBtn);
            updateModalProgress();
            updateCertificateStatusForSprint(sprintKey, startWeek, endWeek);
          }
        });

        taskList.appendChild(taskDiv);
        globalTaskIndex++;
      });
    }

    updateModalProgress();
    updateCertificateStatusForSprint(sprintKey, startWeek, endWeek);

    // Show modal
    document.getElementById('progression-modal').style.display = 'block';
  }

  // Close progression modal
  function closeProgressionModal() {
    document.getElementById('progression-modal').style.display = 'none';
  }

  // Update modal progress
  function updateModalProgress() {
    const checkboxes = document.querySelectorAll('#task-list input[type="checkbox"]');
    const checked = document.querySelectorAll('#task-list input[type="checkbox"]:checked');
    const progress = checkboxes.length > 0 ? (checked.length / checkboxes.length) * 100 : 0;
    document.getElementById('modal-progress-fill').style.width = `${progress}%`;
  }

  // Update certificate status
  function updateCertificateStatus() {
    const availableCertificates = getAvailableCertificates(currentModalWeekNumber);
    const certificateStatus = document.getElementById('certificate-status');

    if (availableCertificates.length > 0) {
      certificateStatus.innerHTML = `
        <button id="view-certificate-btn">View Your Certificate</button>
      `;
    } else {
      certificateStatus.innerHTML = `
        <p style="color: #666; text-align: center;">Complete all tasks to unlock certificates</p>
      `;
    }
  }
  
  // Update certificate status for entire sprint
  function updateCertificateStatusForSprint(sprintKey, startWeek, endWeek) {
    const certificateStatus = document.getElementById('certificate-status');
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    
    if (!sprintCard) {
      certificateStatus.innerHTML = '<p style="color: #666; text-align: center;">Sprint not found</p>';
      return;
    }
    
    // Check if ALL tasks in the sprint are complete
    let totalTasks = 0;
    let completedTasks = 0;
    
    for (let weekNum = startWeek; weekNum <= endWeek; weekNum++) {
      const weekCard = Array.from(sprintCard.querySelectorAll('.week-card')).find(card => 
        extractWeekNumber(card) === weekNum
      );
      
      if (weekCard) {
        const itemCards = weekCard.querySelectorAll('.item-card');
        totalTasks += itemCards.length;
        itemCards.forEach(card => {
          if (card.classList.contains('completed')) {
            completedTasks++;
          }
        });
      }
    }
    
    const isSprintComplete = totalTasks > 0 && completedTasks === totalTasks;
    
    if (isSprintComplete) {
      certificateStatus.innerHTML = `
        <button id="view-certificate-btn" data-sprint="${sprintKey}" data-start="${startWeek}" data-end="${endWeek}">View Your Certificate</button>
      `;
    } else {
      const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      certificateStatus.innerHTML = `
        <p style="color: #666; text-align: center;">Complete all tasks to unlock certificate (${completedTasks}/${totalTasks} - ${progress}%)</p>
      `;
    }
  }

  // Open certificate for sprint (directly show the certificate, no list needed)
  function openCertificateListModal(sprintKey, startWeek, endWeek) {
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    if (!sprintCard) {
      console.error('Sprint card not found');
      return;
    }
    
    const sprintTitle = sprintCard.querySelector('.sprint-title')?.textContent || sprintKey;
    const sprintDescription = sprintCard.querySelector('.sprint-meta:last-of-type')?.textContent || '';
    
    // Check if sprint is complete
    let totalTasks = 0;
    let completedTasks = 0;
    const allGoals = [];
    
    for (let weekNum = startWeek; weekNum <= endWeek; weekNum++) {
      const weekCard = Array.from(sprintCard.querySelectorAll('.week-card')).find(card => 
        extractWeekNumber(card) === weekNum
      );
      
      if (weekCard) {
        const itemCards = weekCard.querySelectorAll('.item-card');
        totalTasks += itemCards.length;
        itemCards.forEach(card => {
          if (card.classList.contains('completed')) {
            completedTasks++;
          }
          // Collect unique task titles as goals
          const taskTitle = card.querySelector('.item-title')?.textContent.trim();
          if (taskTitle && !allGoals.includes(taskTitle)) {
            allGoals.push(taskTitle);
          }
        });
      }
    }
    
    const isSprintComplete = totalTasks > 0 && completedTasks === totalTasks;
    
    if (!isSprintComplete) {
      alert('Please complete all tasks in this sprint to unlock the certificate.');
      return;
    }
    
    // Create sprint-level certificate profile
    const certificateProfile = {
      sprintKey: sprintKey,
      theme: sprintTitle,
      displayName: sprintTitle,
      courseName: COURSE_LABELS[CURRENT_COURSE] || CURRENT_COURSE,
      goal: sprintTitle,
      goals: allGoals.slice(0, 6), // Limit to first 6 goals for display
      weekRange: `Weeks ${startWeek}-${endWeek}`,
      description: sprintDescription
    };
    
    // Open certificate modal directly
    openCertificateModal(certificateProfile);
  }
  
  // ===========================
  // HELP MODAL FUNCTIONALITY
  // ===========================
  
  // Open help modal
  function openHelpModal(sprintKey, helpUrl) {
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    if (!sprintCard) {
      console.error('Sprint card not found');
      return;
    }
    
    // Load markdown content
    loadHelpContent(helpUrl);
    
    // Show modal
    document.getElementById('help-modal').style.display = 'block';
  }
  
  // Close help modal
  function closeHelpModal() {
    document.getElementById('help-modal').style.display = 'none';
  }
  
  // Load help content from Jekyll-rendered page
  async function loadHelpContent(helpUrl) {
    const contentDiv = document.getElementById('help-content');
    contentDiv.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
    
    try {
      const response = await fetch(helpUrl);
      if (!response.ok) {
        throw new Error('Failed to load help content');
      }
      
      const html = await response.text();
      
      // Parse the HTML to extract just the content
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Try to find the main content - adjust selector based on your layout
      // Common selectors: article, .post-content, .content, main
      let content = doc.querySelector('article') || 
                    doc.querySelector('.post-content') || 
                    doc.querySelector('.content') ||
                    doc.querySelector('main');
      
      if (content) {
        contentDiv.innerHTML = content.innerHTML;
      } else {
        // Fallback: use body content if no specific container found
        contentDiv.innerHTML = doc.body.innerHTML;
      }
    } catch (error) {
      console.error('Error loading help content:', error);
      contentDiv.innerHTML = '<p style="color: #e53e3e;">Failed to load help content. Please try again later.</p>';
    }
  }
  
  // Legacy function for week-level (keep for backward compatibility)
  function openCertificateListModalForWeek(weekNumber) {
    document.getElementById('list-modal-sprint-title').textContent = `Week ${weekNumber}`;
    const certificateList = document.getElementById('certificate-list');
    certificateList.innerHTML = '';

    const availableCertificates = getAvailableCertificates(weekNumber);

    if (availableCertificates.length === 0) {
      certificateList.innerHTML = '<p style="color: #666; text-align: center;">No certificates available yet</p>';
    } else {
      availableCertificates.forEach(profile => {
        const button = document.createElement('button');
        button.textContent = `${profile.displayName}`;
        button.addEventListener('click', () => {
          openCertificateModal(profile);
        });
        certificateList.appendChild(button);
      });
    }

    document.getElementById('certificate-list-modal').style.display = 'block';
  }

  // Open certificate modal
  function openCertificateModal(profile) {
    activeCertificateProfile = profile;
    document.getElementById('certificate-week-theme').textContent = profile.theme;
    document.getElementById('certificate-course-name').textContent = profile.courseName;

    // Set date
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('certificate-date').textContent = now.toLocaleDateString('en-US', options);

    // Set goals - for sprint certificates, use the sprint title as main focus
    const goalFocus = profile.goal || profile.theme;
    document.getElementById('certificate-skill-focus').textContent = goalFocus;

    // Add all goals/tasks as skill tags
    const goalsContainer = document.getElementById('skills-container');
    goalsContainer.innerHTML = '';
    
    const goals = profile.goals || [goalFocus];
    goals.forEach(goal => {
      const goalTag = document.createElement('span');
      goalTag.className = 'skill-tag';
      goalTag.textContent = goal;
      goalsContainer.appendChild(goalTag);
    });

    // Close list modal and open certificate modal
    document.getElementById('certificate-list-modal').style.display = 'none';
    document.getElementById('certificate-modal').style.display = 'block';
  }

  // Close certificate modal
  function closeCertificateModal() {
    document.getElementById('certificate-modal').style.display = 'none';
  }

  // Close certificate list modal
  function closeCertificateListModal() {
    document.getElementById('certificate-list-modal').style.display = 'none';
  }

  // Download certificate
  function downloadCertificate() {
    const certificateContent = document.getElementById('certificate-content');
    html2canvas(certificateContent, {
      scale: 3,
      backgroundColor: '#ffffff',
      logging: false,
      useCORS: true
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'certificate.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  }

  // Print certificate
  function printCertificate() {
    window.print();
  }

  // Share on LinkedIn by opening the certification form with prefilled data
  function shareOnLinkedIn() {
    const profile = activeCertificateProfile;
    const certificateName = profile?.displayName || profile?.theme || document.getElementById('certificate-week-theme')?.textContent.trim() || 'Course Module Completion';
    const courseName = profile?.courseName || document.getElementById('certificate-course-name')?.textContent.trim() || 'Open Coding Society';
    const studentName = document.getElementById('certificate-student-name')?.textContent.trim() || 'Learner';
    const issueDateText = document.getElementById('certificate-date')?.textContent.trim() || '';
    const goalFocus = profile?.goal || document.getElementById('certificate-skill-focus')?.textContent.trim() || certificateName;

    let issueMonth = '';
    let issueYear = '';

    if (issueDateText) {
      const parsedDate = new Date(issueDateText);
      if (!isNaN(parsedDate.getTime())) {
        issueMonth = (parsedDate.getMonth() + 1).toString();
        issueYear = parsedDate.getFullYear().toString();
      }
    }

    const params = new URLSearchParams({
      startTask: 'CERTIFICATION_NAME',
      name: `${certificateName}`,
      organizationName: 'Open Coding Society',
      issueYear,
      issueMonth,
      description: `Awarded to ${studentName} for demonstrating ${goalFocus} during ${courseName}`,
      credentialUrl: window.location.href
    });

    const linkedInUrl = `https://www.linkedin.com/profile/add?${params.toString()}`;
    window.open(linkedInUrl, '_blank', 'noopener');
  }

  // Initialize certificate system
  function initializeCertificateSystem() {
    // Sprint-level progression buttons
    document.querySelectorAll('.sprint-controls .progression-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const startWeek = parseInt(btn.dataset.start);
        const endWeek = parseInt(btn.dataset.end);
        openProgressionModal(sprintKey, startWeek, endWeek);
      });
    });
    
    console.log('Initializing certificate system');

    const weekCards = document.querySelectorAll('.week-card');
    console.log('Found', weekCards.length, 'week cards');

    function toggleSprint(card, control) {
      const isCollapsed = card.classList.toggle('collapsed');
      if (control) {
        control.setAttribute('aria-expanded', (!isCollapsed).toString());
        control.querySelector('.sprint-toggle-icon').textContent = isCollapsed ? '▸' : '▾';
      }
    }

    document.querySelectorAll('.sprint-card').forEach(card => {
      const toggleBtn = card.querySelector('.sprint-toggle-btn');
      if (toggleBtn) {
        toggleBtn.querySelector('.sprint-toggle-icon').textContent = '▸';
        toggleBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          toggleSprint(card, toggleBtn);
        });
      }
      card.querySelector('.sprint-header').addEventListener('click', (event) => {
        if (event.target.closest('.sprint-controls')) {
          return;
        }
        toggleSprint(card, toggleBtn);
      });
    });

    // Close buttons
    document.getElementById('close-progression-modal').addEventListener('click', closeProgressionModal);
    document.getElementById('close-certificate-list-modal').addEventListener('click', closeCertificateListModal);
    document.getElementById('close-certificate-modal').addEventListener('click', closeCertificateModal);

    // Certificate actions
    document.getElementById('download-certificate-btn').addEventListener('click', downloadCertificate);
    document.getElementById('print-certificate-btn').addEventListener('click', printCertificate);
    document.getElementById('linkedin-share-btn').addEventListener('click', shareOnLinkedIn);

    // View certificate button (handles sprint-level data)
    document.addEventListener('click', function(e) {
      if (e.target.id === 'view-certificate-btn') {
        console.log('Certificate button clicked!');
        console.log('Sprint key:', e.target.dataset.sprint);
        console.log('Start week:', e.target.dataset.start);
        console.log('End week:', e.target.dataset.end);
        
        closeProgressionModal();
        const sprintKey = e.target.dataset.sprint;
        const startWeek = parseInt(e.target.dataset.start);
        const endWeek = parseInt(e.target.dataset.end);
        
        if (sprintKey && !isNaN(startWeek) && !isNaN(endWeek)) {
          console.log('Calling openCertificateListModal with:', sprintKey, startWeek, endWeek);
          openCertificateListModal(sprintKey, startWeek, endWeek);
        } else if (currentModalWeekNumber) {
          // Fallback to old week-level behavior if needed
          console.log('Falling back to week-level with week:', currentModalWeekNumber);
          openCertificateListModalForWeek(currentModalWeekNumber);
        } else {
          console.error('No sprint data or week number available');
        }
      }
    });
  }

  // Cross-view synchronization - sync when switching between timeline and two-pane views
  window.addEventListener('focus', function() {
    updateAllCompletionStates();
  });
  
  // Sync when page becomes visible (handles tab switching)
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      updateAllCompletionStates();
    }
  });
  
  // Listen for storage changes from other tabs/windows (cross-tab sync)
  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY) {
      updateAllCompletionStates();
    }
  });
  
  // Listen for completion changes from other views (same-window sync)
  window.addEventListener('completionChanged', function(e) {
    updateAllCompletionStates();
  });

  // Update all completion states from localStorage
  function updateAllCompletionStates() {
    const completionData = loadCompletionData();
    const itemCards = document.querySelectorAll('.item-card');
    
    itemCards.forEach(card => {
      const itemId = card.dataset.itemId;
      const isCompleted = completionData[itemId] || false;
      updateItemUI(card, isCompleted);
    });
    
    updateProgressBars();
  }

  // Mobile-specific enhancements
  function initMobileEnhancements() {
    if (window.innerWidth <= 768) {
      // Auto-collapse all sprints on mobile for better navigation
      document.querySelectorAll('.sprint-card:not(.collapsed)').forEach(card => {
        card.classList.add('collapsed');
      });
      
      // Add touch-friendly interactions for modals
      document.querySelectorAll('.progression-btn').forEach(btn => {
        btn.style.minHeight = '44px'; // iOS recommended touch target size
      });
      
      // Improve modal close buttons for mobile
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.style.minWidth = '44px';
        btn.style.minHeight = '44px';
        btn.style.display = 'flex';
        btn.style.alignItems = 'center';
        btn.style.justifyContent = 'center';
      });
    }
  }

  // Handle orientation changes
  window.addEventListener('orientationchange', function() {
    setTimeout(function() {
      updateProgressBars();
      initMobileEnhancements();
    }, 100);
  });

  document.addEventListener('DOMContentLoaded', function() {
    initializeProgressBars();
    initializeCompletion();
    initializeSprintFilters();
    initializeCertificateSystem();
    renderWeekGoalPreviews();
    initMobileEnhancements();
    initializeHelpButtons();
    initializeSprintDates();
  });
  
  // Initialize help button event listeners
  function initializeHelpButtons() {
    // Help button click handlers
    document.querySelectorAll('.help-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const helpUrl = btn.dataset.helpUrl;
        openHelpModal(sprintKey, helpUrl);
      });
    });
    
    // Close help modal
    const closeHelpBtn = document.getElementById('close-help-modal');
    if (closeHelpBtn) {
      closeHelpBtn.addEventListener('click', closeHelpModal);
    }
    
    // Close on outside click
    const helpModal = document.getElementById('help-modal');
    if (helpModal) {
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) {
          closeHelpModal();
        }
      });
    }
  }

  // ============================= 
  //   SPRINT DATE MANAGEMENT     
  // ============================= 
  
  const SPRINT_DATES_STORAGE_KEY = 'sprintDates';
  let cachedSprintDates = null;
  
  // Load sprint dates from localStorage (fallback)
  function loadSprintDates() {
    try {
      const stored = localStorage.getItem(SPRINT_DATES_STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      console.error('Error loading sprint dates:', e);
      return {};
    }
  }
  
  // Load sprint dates from backend API
  async function loadSprintDatesFromBackend(course) {
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      const response = await fetch(`${javaURI}/api/sprint-dates/${course}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        // Convert array to keyed object for easy lookup
        const sprintDates = {};
        data.forEach(sd => {
          const key = `${sd.course}_${sd.sprintKey}`;
          sprintDates[key] = {
            startDate: sd.startDate,
            endDate: sd.endDate,
            course: sd.course,
            sprintKey: sd.sprintKey,
            startWeek: sd.startWeek,
            endWeek: sd.endWeek
          };
        });
        return sprintDates;
      }
      return null;
    } catch (error) {
      console.log('Backend API not available for loading sprint dates:', error.message);
      return null;
    }
  }
  
  // Save sprint dates to localStorage
  function saveSprintDatesToStorage(dates) {
    try {
      localStorage.setItem(SPRINT_DATES_STORAGE_KEY, JSON.stringify(dates));
    } catch (e) {
      console.error('Error saving sprint dates:', e);
    }
  }
  
  // Format date for display
  function formatDateDisplay(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  
  // Initialize sprint date controls
  async function initializeSprintDates() {
    // Get course from page (e.g., "csa", "csp", "csse")
    const courseInput = document.querySelector('.sprint-start-date[data-course]');
    const course = courseInput ? courseInput.dataset.course : null;
    
    // Try to load from backend first, fallback to localStorage
    let sprintDates = {};
    if (course) {
      const backendDates = await loadSprintDatesFromBackend(course);
      if (backendDates) {
        sprintDates = backendDates;
        // Also cache to localStorage for offline access
        const existingDates = loadSprintDates();
        Object.assign(existingDates, backendDates);
        saveSprintDatesToStorage(existingDates);
      } else {
        sprintDates = loadSprintDates();
      }
    } else {
      sprintDates = loadSprintDates();
    }
    
    // Toggle dropdown visibility
    document.querySelectorAll('.sprint-btn.date-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const dropdown = document.querySelector(`.sprint-date-dropdown[data-sprint="${sprintKey}"]`);
        
        // Close all other dropdowns
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          if (d !== dropdown) d.classList.add('hidden');
        });
        
        dropdown.classList.toggle('hidden');
      });
    });
    
    // Close dropdown buttons
    document.querySelectorAll('.date-dropdown-close').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        btn.closest('.sprint-date-dropdown').classList.add('hidden');
      });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sprint-date-control')) {
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          d.classList.add('hidden');
        });
      }
    });
    
    // Load saved dates into inputs
    document.querySelectorAll('.sprint-start-date').forEach(input => {
      const sprintKey = input.dataset.sprint;
      const course = input.dataset.course;
      const key = `${course}_${sprintKey}`;
      
      if (sprintDates[key] && sprintDates[key].startDate) {
        input.value = sprintDates[key].startDate;
      }
    });
    
    document.querySelectorAll('.sprint-end-date').forEach(input => {
      const sprintKey = input.dataset.sprint;
      const course = input.dataset.course;
      const key = `${course}_${sprintKey}`;
      
      if (sprintDates[key] && sprintDates[key].endDate) {
        input.value = sprintDates[key].endDate;
      }
    });
    
    // Save button handlers
    document.querySelectorAll('.save-sprint-dates-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        
        await saveSprintDates(sprintKey, course, btn);
      });
    });
  }
  
  // Save sprint dates and add to calendar
  async function saveSprintDates(sprintKey, course, btn) {
    const startInput = document.querySelector(`.sprint-start-date[data-sprint="${sprintKey}"]`);
    const endInput = document.querySelector(`.sprint-end-date[data-sprint="${sprintKey}"]`);
    const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
    
    const startDate = startInput.value;
    const endDate = endInput.value;
    const startWeek = parseInt(btn.dataset.startWeek);
    const endWeek = parseInt(btn.dataset.endWeek);
    
    // Validation
    if (!startDate || !endDate) {
      showDateStatus(statusEl, 'Please select both start and end dates', 'error');
      return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
      showDateStatus(statusEl, 'Start date must be before end date', 'error');
      return;
    }
    
    btn.disabled = true;
    showDateStatus(statusEl, 'Saving & adding events...', 'loading');
    
    try {
      // Get sprint title for calendar event
      const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
      const sprintTitle = sprintCard ? sprintCard.querySelector('.sprint-title')?.textContent?.trim() : sprintKey;
      
      // Collect week assignments from the page
      const weekAssignments = collectWeekAssignments(sprintKey);
      
      // Try to save to backend first (backend handles calendar sync)
      const backendSuccess = await saveSprintDatesToBackend({
        course,
        sprintKey,
        sprintTitle,
        startDate,
        endDate,
        startWeek,
        endWeek,
        weekAssignments
      });
      
      if (backendSuccess) {
        // Backend saved and created calendar events
        showDateStatus(statusEl, '✓ All events added to calendar!', 'success');
      } else {
        // Fallback: Save to localStorage and call calendar API directly
        console.log('Backend unavailable, using localStorage fallback');
        
        const sprintDates = loadSprintDates();
        const key = `${course}_${sprintKey}`;
        sprintDates[key] = {
          startDate,
          endDate,
          course,
          sprintKey,
          startWeek,
          endWeek
        };
        saveSprintDatesToStorage(sprintDates);
        
        // Add events directly to calendar API
        const calendarSuccess = await addAllSprintEventsToCalendar(
          sprintKey, course, sprintTitle, startDate, endDate, startWeek, endWeek
        );
        
        if (calendarSuccess) {
          showDateStatus(statusEl, '✓ Events added to calendar!', 'success');
        } else {
          showDateStatus(statusEl, '✓ Saved locally (calendar sync failed)', 'success');
        }
      }
      
      // Update any date display elements
      updateSprintDateDisplay(sprintKey, startDate, endDate);
      
    } catch (error) {
      console.error('Error saving sprint dates:', error);
      showDateStatus(statusEl, 'Error saving dates', 'error');
    } finally {
      btn.disabled = false;
    }
  }
  
  // Collect week assignments from the page DOM
  function collectWeekAssignments(sprintKey) {
    const weekAssignments = {};
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    
    if (sprintCard) {
      const weekCards = sprintCard.querySelectorAll('.week-card');
      weekCards.forEach(weekCard => {
        const weekNum = weekCard.dataset.week;
        const assignments = weekCard.dataset.assignments || '';
        
        if (assignments) {
          weekAssignments[weekNum] = assignments.split(';;;').filter(a => a.trim());
        } else {
          weekAssignments[weekNum] = [];
        }
      });
    }
    
    return weekAssignments;
  }
  
  // Save sprint dates to backend API
  async function saveSprintDatesToBackend(data) {
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      console.log('Attempting to save sprint dates to backend:', javaURI);
      console.log('Request data:', JSON.stringify(data, null, 2));
      
      // Try to POST to backend (backend handles all calendar event creation)
      const response = await fetch(`${javaURI}/api/sprint-dates`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      console.log('Backend response status:', response.status);
      
      if (response.ok) {
        const result = await response.json();
        console.log('Backend success response:', result);
        console.log(`Backend created ${result.eventsCreated || 'N/A'} calendar events`);
        return true;
      } else if (response.status === 409) {
        // Sprint date exists, try PUT to update
        console.log('Sprint exists, trying PUT to update...');
        const updateResponse = await fetch(`${javaURI}/api/sprint-dates/${data.course}/${data.sprintKey}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        console.log('PUT response status:', updateResponse.status);
        
        if (updateResponse.ok) {
          const result = await updateResponse.json();
          console.log('Backend update success:', result);
          console.log(`Backend updated sprint, created ${result.eventsCreated || 'N/A'} calendar events`);
          return true;
        } else {
          const errorText = await updateResponse.text();
          console.error('PUT failed:', errorText);
        }
      } else {
        // Log the error response
        const errorText = await response.text();
        console.error('Backend POST failed:', response.status, errorText);
      }
      
      return false;
    } catch (error) {
      console.error('Backend API error:', error);
      return false;
    }
  }
  
  // Calculate the date for a specific week within the sprint date range
  function calculateWeekDate(sprintStartDate, sprintEndDate, weekNumber, startWeekNumber, endWeekNumber) {
    const start = new Date(sprintStartDate);
    const end = new Date(sprintEndDate);
    const totalWeeks = endWeekNumber - startWeekNumber + 1;
    const weekIndex = weekNumber - startWeekNumber;
    
    // Calculate total days in sprint
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    
    // Calculate days per week
    const daysPerWeek = totalDays / totalWeeks;
    
    // Calculate the start date for this week
    const weekStartDate = new Date(start);
    weekStartDate.setDate(weekStartDate.getDate() + Math.round(weekIndex * daysPerWeek));
    
    // Calculate the end date for this week (start of next week - 1 day, or sprint end)
    const weekEndDate = new Date(start);
    weekEndDate.setDate(weekEndDate.getDate() + Math.round((weekIndex + 1) * daysPerWeek) - 1);
    
    // Make sure we don't exceed the sprint end date
    if (weekEndDate > end) {
      weekEndDate.setTime(end.getTime());
    }
    
    return {
      start: weekStartDate.toISOString().split('T')[0],
      end: weekEndDate.toISOString().split('T')[0]
    };
  }
  
  // Add all sprint events to calendar (sprint start/end + weeks + assignments)
  async function addAllSprintEventsToCalendar(sprintKey, course, sprintTitle, startDate, endDate, startWeek, endWeek) {
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      const courseName = course.toUpperCase();
      const events = [];
      
      // 1. Sprint Start Event
      events.push({
        title: `🚀 ${sprintKey} Start: ${sprintTitle}`,
        description: `${courseName} ${sprintKey} begins.\nSprint: ${sprintTitle}\nWeeks ${startWeek}-${endWeek}`,
        date: startDate,
        period: courseName
      });
      
      // 2. Sprint End Event
      events.push({
        title: `🏁 ${sprintKey} End: ${sprintTitle}`,
        description: `${courseName} ${sprintKey} ends.\nSprint: ${sprintTitle}`,
        date: endDate,
        period: courseName
      });
      
      // 3. Get all weeks in this sprint and add week events + assignment due dates
      const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
      if (sprintCard) {
        const weekCards = sprintCard.querySelectorAll('.week-card');
        
        weekCards.forEach(weekCard => {
          const weekNum = parseInt(weekCard.dataset.week);
          const assignments = weekCard.dataset.assignments || '';
          
          // Calculate the date for this week
          const weekDates = calculateWeekDate(startDate, endDate, weekNum, startWeek, endWeek);
          
          // Add week start event
          events.push({
            title: `📅 Week ${weekNum} - ${courseName}`,
            description: `${courseName} ${sprintKey} - Week ${weekNum}\nSprint: ${sprintTitle}`,
            date: weekDates.start,
            period: courseName
          });
          
          // Add assignment due dates (assignments are due at end of their week)
          if (assignments) {
            const assignmentList = assignments.split(';;;').filter(a => a.trim());
            assignmentList.forEach(assignmentTitle => {
              events.push({
                title: `📝 Due: ${assignmentTitle}`,
                description: `${courseName} Assignment Due\nWeek ${weekNum} - ${sprintKey}\n${assignmentTitle}`,
                date: weekDates.end,
                period: courseName
              });
            });
          }
        });
      }
      
      // Send all events to calendar API
      console.log(`Adding ${events.length} events to calendar for ${sprintKey}`);
      
      const results = await Promise.all(
        events.map(event => 
          fetch(`${javaURI}/api/calendar/add_event`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(event)
          }).then(res => res.ok).catch(() => false)
        )
      );
      
      const successCount = results.filter(r => r).length;
      console.log(`Successfully added ${successCount}/${events.length} events`);
      
      return successCount > 0;
    } catch (error) {
      console.error('Error adding sprint events to calendar:', error);
      return false;
    }
  }
  
  // Show status message
  function showDateStatus(el, message, type) {
    if (!el) return;
    el.textContent = message;
    el.className = 'sprint-date-status ' + type;
    
    if (type === 'success' || type === 'error') {
      setTimeout(() => {
        el.textContent = '';
        el.className = 'sprint-date-status';
      }, 4000);
    }
  }
  
  // Update date display (if you want to show dates in the UI)
  function updateSprintDateDisplay(sprintKey, startDate, endDate) {
    const displayEl = document.querySelector(`.sprint-dates-display[data-sprint="${sprintKey}"]`);
    if (displayEl) {
      const rangeEl = displayEl.querySelector('.date-range');
      if (rangeEl) {
        rangeEl.textContent = `${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;
      }
    }
  }

</script>
</div>
<!-- End .timeline-page -->
